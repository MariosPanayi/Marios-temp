---
title: "Conditioned Reinforcement"
author: "Marios Panayi"
date: "12/28/2020"
output: word_document
---

```{r setup, include=FALSE, message = FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE)
## Packages for data organisation and plotting
library(tidyverse)
# Package for relative file paths
library(here)
# library(ggpubr)
library(cowplot)
library(ggsignif)
library(patchwork)
################################################################################
## Packages for Data analysis
library(afex)
afex_options(emmeans_model = "multivariate")# use multivariate model for all follow-up tests.
library(emmeans)
# install.packages("devtools")
# devtools::install_github("crsh/papaja")
library(papaja)
library(knitr)
# remotes::install_github("noamross/redoc")
# library(redoc)
```



```{r Load data from figures for Stats , include=FALSE, message = FALSE, warning=FALSE}
CRF_Acquisition_CSPre <- read_csv(here("figures","figure_data","CRF_Acquisition_CSPre.csv"))
CRF_Acquisition_CSPre_Last5s <- read_csv(here("figures","figure_data","CRF_Acquisition_CSPre_Last5s.csv"))
# Test Data
CRF_data_P100_HighvsLow_long <- read_csv(here("figures","figure_data","CRF_data_P100_HighvsLow_long.csv"))
CRF_data_P50_HighvsLow_long <- read_csv(here("figures","figure_data","CRF_data_P50_HighvsLow_long.csv"))
CRF_data_High_100Vs50_long <- read_csv(here("figures","figure_data","CRF_data_High_100Vs50_long.csv"))
CRF_data_Low_100Vs50_long <- read_csv(here("figures","figure_data","CRF_data_Low_100Vs50_long.csv"))

# Test Data Create average session data
CRF_data_P100_HighvsLow_long_Avg <- CRF_data_P100_HighvsLow_long %>% 
  group_by(TestCondition, Day, subject, measure, Value, Probability) %>% 
  summarise(Freq = sum(Freq)) 

CRF_data_P50_HighvsLow_long_Avg <- CRF_data_P50_HighvsLow_long %>% 
  group_by(TestCondition, Day, subject, measure, Value, Probability) %>% 
  summarise(Freq = sum(Freq)) 

CRF_data_High_100Vs50_long_Avg <- CRF_data_High_100Vs50_long %>% 
  group_by(TestCondition, Day, subject, measure, Value, Probability) %>% 
  summarise(Freq = sum(Freq)) 

CRF_data_Low_100Vs50_long_Avg <- CRF_data_Low_100Vs50_long %>% 
  group_by(TestCondition, Day, subject, measure, Value, Probability) %>% 
  summarise(Freq = sum(Freq)) 

## Check things are being averaged correctly 
# CRF_data_P100_HighvsLow_long_Avg %>% 
#      count(unique(subject)) %>% 
# kable()

CRF_data_HighvsLow_long_combined <- full_join(CRF_data_P100_HighvsLow_long_Avg, CRF_data_P50_HighvsLow_long_Avg)
CRF_data_100Vs50_long_combined <- full_join(CRF_data_High_100Vs50_long_Avg, CRF_data_Low_100Vs50_long_Avg)

CRF_data_P100_HighvsLow_long_Avg <- CRF_data_P100_HighvsLow_long_Avg %>% 
pivot_wider(names_from = c(Value, Probability, measure), values_from =  Freq) %>% 
  mutate(ExcludeSubject = ifelse(High_P100_CS == 0 | Low_P100_CS == 0, "Exclude", "Keep"),
         Diff_P100_CS = High_P100_CS - Low_P100_CS,
         Diff_P100_LP = High_P100_LP - Low_P100_LP,
         PercDiff_P100_LP = 100*(High_P100_LP - Low_P100_LP)/ (High_P100_LP + Low_P100_LP)) %>% 
  pivot_longer(c(4:7, 9:11),names_to = c("Value", "Probability", "measure"), names_sep = "_" , values_to = c("Freq"))

CRF_data_P50_HighvsLow_long_Avg <- CRF_data_P50_HighvsLow_long_Avg %>% 
pivot_wider(names_from = c(Value, Probability, measure), values_from =  Freq) %>% 
  mutate(ExcludeSubject = ifelse(High_P50_CS == 0 | Low_P50_CS == 0, "Exclude", "Keep"),
         Diff_P50_CS = High_P50_CS - Low_P50_CS,
         Diff_P50_LP = High_P50_LP - Low_P50_LP,
         PercDiff_P50_LP = 100*(High_P50_LP - Low_P50_LP)/ (High_P50_LP + Low_P50_LP)) %>% 
  pivot_longer(c(4:7, 9:11),names_to = c("Value", "Probability", "measure"), names_sep = "_" , values_to = c("Freq"))

CRF_data_High_100Vs50_long_Avg <- CRF_data_High_100Vs50_long_Avg %>% 
pivot_wider(names_from = c(Value, Probability, measure), values_from =  Freq) %>% 
  mutate(ExcludeSubject = ifelse(High_P100_CS == 0 | High_P50_CS == 0, "Exclude", "Keep"),
         Diff_High_CS = High_P100_CS - High_P50_CS,
         Diff_High_LP = High_P100_LP - High_P50_LP,
         PercDiff_High_LP = 100*(High_P100_LP - High_P50_LP)/ (High_P100_LP + High_P50_LP)) %>% 
  pivot_longer(c(4:7, 9:11),names_to = c("Value", "Probability", "measure"), names_sep = "_" , values_to = c("Freq"))

CRF_data_Low_100Vs50_long_Avg <- CRF_data_Low_100Vs50_long_Avg %>% 
pivot_wider(names_from = c(Value, Probability, measure), values_from =  Freq) %>% 
    mutate(ExcludeSubject = ifelse(Low_P100_CS == 0 | Low_P50_CS == 0, "Exclude", "Keep"),
         Diff_Low_CS = Low_P100_CS - Low_P50_CS,
         Diff_Low_LP = Low_P100_LP - Low_P50_LP,
         PercDiff_Low_LP = 100*(Low_P100_LP - Low_P50_LP)/ (Low_P100_LP + Low_P50_LP)) %>% 
  pivot_longer(c(4:7, 9:11),names_to = c("Value", "Probability", "measure"), names_sep = "_" , values_to = c("Freq"))


```



```{r Stage 1 Acquisition STats , include=FALSE, message = FALSE, warning=FALSE}
rawdata <- CRF_Acquisition_CSPre %>% 
  filter(Period == "CS")
# Stage 1 Acquisition Frequency
anova <- aov_4(MagEntries ~ (Day*CS_name|subject), data = rawdata, anova_table = list(correction = "none", es = "pes"))
anova_Stg1_Freq <- apa_print(anova, mse = "FALSE",correction = "none",es = "pes")
## simple effects - linear trend on Day
simple <- emmeans(anova, ~CS_name)
simple_Stg1_Freq <- apa_print(contrast(simple, interaction = "pairwise", adjust = "tukey"))

anova_Stg1_Freq$table
simple_Stg1_Freq$table


# Stage 1 Acquisition Duration
anova <- aov_4(MagDuration ~ (Day*CS_name|subject), data = rawdata, anova_table = list(correction = "none", es = "pes"))
anova_Stg1_Dur <- apa_print(anova, mse = "FALSE",correction = "none",es = "pes")
## simple effects - linear trend on Day
simple <- emmeans(anova, ~CS_name)
simple_Stg1_Dur <- apa_print(contrast(simple, interaction = "pairwise", adjust = "tukey"))

anova_Stg1_Dur$table
simple_Stg1_Dur$table

```



```{r Stage 1 Acquisition STats Mag*prob , include=FALSE, message = FALSE, warning=FALSE}
rawdata <- CRF_Acquisition_CSPre %>% 
  filter(Period == "CS",
         Day < 7)
# Stage 1 Acquisition Frequency
anova <- aov_4(MagEntries ~ (Day*magnitude*probability|subject), data = rawdata, anova_table = list(correction = "none", es = "pes"))
anova_Stg1_Freq <- apa_print(anova, mse = "FALSE",correction = "none",es = "pes")
## simple effects - linear trend on Day
simple <- emmeans(anova, ~Day*probability)
simple_Stg1_Freq <- apa_print(contrast(simple, interaction = "poly", by = "probability", adjust = "tukey"))

anova_Stg1_Freq$table
simple_Stg1_Freq$table


# Stage 1 Acquisition Duration
anova <- aov_4(MagDuration ~ (Day*magnitude*probability|subject), data = rawdata, anova_table = list(correction = "none", es = "pes"))
anova_Stg1_Dur <- apa_print(anova, mse = "FALSE",correction = "none",es = "pes")
## simple effects - linear trend on Day
simple <- emmeans(anova, ~Day*probability)
simple_Stg1_Dur <- apa_print(contrast(simple, interaction = "pairwise", by = "Day", adjust = "tukey"))

anova_Stg1_Dur$table
simple_Stg1_Dur$table
```


`r apa_table(within(anova_Stg1_Freq$table, rm(pes)),caption = "Magazine Frequency ANOVA")`



`r apa_table(within(anova_Stg1_Dur$table, rm(pes)),caption = "Magazine Duration ANOVA")`


```{r Stage 1 Acquisition Last 5s Stats , include=FALSE, message = FALSE, warning=FALSE}
rawdata <- CRF_Acquisition_CSPre_Last5s %>% 
  filter(Period == "CS",
         Day < 7)
# Stage 1 Acquisition Frequency
anova <- aov_4(MagEntries ~ (Day*CS_name|subject), data = rawdata, anova_table = list(correction = "none", es = "pes"))
anova_Stg1_Freq_5s <- apa_print(anova, mse = "FALSE",correction = "none",es = "pes")
## simple effects - linear trend on Day
simple <- emmeans(anova, ~CS_name)
simple_Stg1_Freq_5s <- apa_print(contrast(simple, interaction = "pairwise", adjust = "tukey"))

anova_Stg1_Freq_5s$table
simple_Stg1_Freq_5s$table


# Stage 1 Acquisition Duration
anova <- aov_4(MagDuration ~ (Day*CS_name|subject), data = rawdata, anova_table = list(correction = "none", es = "pes"))
anova_Stg1_Dur_5s <- apa_print(anova, mse = "FALSE",correction = "none",es = "pes")
## simple effects - linear trend on Day
simple <- emmeans(anova, ~CS_name)
simple_Stg1_Dur_5s <- apa_print(contrast(simple, interaction = "pairwise", adjust = "tukey"))

anova_Stg1_Dur_5s$table
simple_Stg1_Dur_5s$table
```




```{r Stage 1 Acquisition Last 5s Stats mag*prob , include=FALSE, message = FALSE, warning=FALSE}
rawdata <- CRF_Acquisition_CSPre_Last5s %>% 
  filter(Period == "CS")
# Stage 1 Acquisition Frequency
anova <- aov_4(MagEntries ~ (Day*magnitude*probability|subject), data = rawdata, anova_table = list(correction = "none", es = "pes"))
anova_Stg1_Freq_5s <- apa_print(anova, mse = "FALSE",correction = "none",es = "pes")
## simple effects - linear trend on Day
simple <- emmeans(anova, ~magnitude*probability)
simple_Stg1_Freq_5s <- apa_print(contrast(simple, interaction = "pairwise", by = "probability", adjust = "tukey"))

anova_Stg1_Freq_5s$table
simple_Stg1_Freq_5s$table


# Stage 1 Acquisition Duration
anova <- aov_4(MagDuration ~ (Day*magnitude*probability|subject), data = rawdata, anova_table = list(correction = "none", es = "pes"))
anova_Stg1_Dur_5s <- apa_print(anova, mse = "FALSE",correction = "none",es = "pes")
## simple effects - linear trend on Day
simple <- emmeans(anova, ~magnitude*probability)
simple_Stg1_Dur_5s <- apa_print(contrast(simple, interaction = "pairwise",  by = "probability", adjust = "tukey"))

anova_Stg1_Dur_5s$table
simple_Stg1_Dur_5s$table
```


`r apa_table(within(anova_Stg1_Freq_5s$table, rm(pes)),caption = "Magazine Frequency ANOVA - 5s")`



`r apa_table(within(anova_Stg1_Dur_5s$table, rm(pes)),caption = "Magazine Duration ANOVA - 5s")`





```{r Test CRF HighvsLow Value comparisons Stats , include=FALSE, message = FALSE, warning=FALSE}
rawdata <- CRF_data_HighvsLow_long_combined %>% 
  filter(measure == "LP")
# Stage 1 Acquisition Frequency
anova <- aov_4(Freq ~ (Value*Probability|subject), data = rawdata, anova_table = list(correction = "none", es = "pes"))
anova_test_Value <- apa_print(anova, mse = "FALSE",correction = "none",es = "pes")
## simple effects - linear trend on Day
simple <- emmeans(anova, ~Value*Probability)
simple_Test_Value <- apa_print(contrast(simple, interaction = "pairwise", by = "Probability", adjust = "tukey"))

anova_test_Value$table
simple_Test_Value$table


rawdata <- CRF_data_100Vs50_long_combined %>% 
  filter(measure == "LP")
# Stage 1 Acquisition Frequency
anova <- aov_4(Freq ~ (Value*Probability|subject), data = rawdata, anova_table = list(correction = "none", es = "pes"))
anova_test_Probability <- apa_print(anova, mse = "FALSE",correction = "none",es = "pes")
## simple effects - linear trend on Day
simple <- emmeans(anova, ~Value*Probability)
simple_Test_Probability <- apa_print(contrast(simple, interaction = "pairwise", by = "Value", adjust = "tukey"))

anova_test_Probability$table
simple_Test_Probability$table

```



`r CRF_data_HighvsLow_Table`
`r CRF_data_100Vs50_Table`


